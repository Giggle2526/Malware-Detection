# 使用自适应特征映射(Self Organising Feature Maps)和计算机活动数据对恶意软件进行分类

## 摘要

在本文中，我们使用机器活动度量来自动区分恶意和可信的可移植可执行软件样本。这一动机源于使用秘密部署高级持续威胁(APTs)技术的网络攻击的增长。APT正在变得越来越复杂，并且可以通过“加密“、”自定义代码”和“在内存中运行”来混淆其可识别特性。我们的假设是，我们可以使用机器学习来区分恶意样本和可信样本，其特征来自于计算机系统在执行过程中留下的不可避免的足迹。这包括CPU、RAM、SWAP内存、字节级和数据包级的网络流量统计。这些特征是连续的，与构成现存文献主要特征的离散特征(如API调用)相比，允许我们更灵活地对样本进行分类。我们使用这些连续的数据，并开发了一种新的分类方法，使用自组织特征映射(Self  - Organizing Feature  map)，通过创建无监督的相似“行为”集群的能力来减少训练过程中的过拟合，这些“行为”随后被用作分类的特征，而不是使用原始数据。我们将本方法与先前研究的一系列机器学习分类方法进行比较，使用本方法在准确度上有了7.24%至25.68%的提升，在使用未参与训练的测试集时提升程度超过了这一范围。

Keywords: malware; machine learning; self organising maps; intrusion detection; data science; security operation centre

## 一、引言

对网络安全分析人员来说，检测“故意实现攻击者的有害意图”的恶意软件一直是一个困难的挑战。攻击者正在开发越来越复杂的方法来避免检测基于软件漏洞和薄弱配置的技术安全对策。典型的网络安全对策包括网络入侵检测系统(NIDS)，它能够执行细粒度的网络数据和协议级分析，以识别异常和恶意流量；反病毒工具扫描软件并试图匹配恶意代码库列表的代码签名。

这种极度复杂的恶意软件被称为高级持续威胁(APTs)。一项对“四大APT“(震网病毒、火焰病毒、Duqu病毒和红色十月病毒)的深入研究揭示了恶意软件能够逃避安检的因素。这些因素包括：

1. 加密并混淆网络流量，限制网络流量分析的有效性。

   命令和控制服务器在端口22/TCP、80/TCP和443/TCP上接收流量，因此恶意软件常将出口流量与其他HTTP报文（80/TCP）合并或在传输过程中加密为22/TCP、443/TCP报文。对于HTTP流量，Duqu病毒在传输前将数据转换为JPEG图像文件，避免了包级分析；

2. Stuxnet、Flame和Duqu扫描目标终端安全产品，并根据检测结果定制相应类型的流量载荷来规避检测，限制了可执行文件基于静态分析的签名的有效性；

3. Red十月在内存中执行来确保不被检测。

[2]得出结论，反病毒和网络入侵检测产品在检测APT方面面临着严重的缺陷，并提出分析恶意软件在攻击的生命周期中不可避免地产生的“低严重性事件“作为未来的研究方向。因此，本文通过在沙盒环境中执行恶意和可信的可执行文件样本，生成一系列系统级活动指标，并使用这些指标训练机器分类器来区分恶意代码和可信任的可执行文件，使用“不可避免地产生的低级别事件”——即CPU用户使用(百分比)，CPU系统使用(百分比)，RAM使用(计数)，SWAP使用(计数)，接收数据包(计数)，接收字节(计数)，发送包(count)，发送字节(count)，运行的进程数(count)——共9个度量。

由于每天都有如此多的新恶意软件实例出现，故分类器的另一个考虑因素是检测出以前未见的行为的恶意软件的能力。McAfee表示，每天有数万个不同的样本被查看，而VirusTotal提供的统计数据显示，在20172年2月12日，有137万个不同的新样本被提交。这是一项重要的任务，并且一个重要的测试是分类模型能否将用于训练的特征概括为未见的特征。使用一组不同的样本来测试分类可以部分测试该泛化能力。并不是所有以前的工作都这样做：一些现有的研究论文使用k-fold交叉验证，它将数据集分割为迭代的训练/测试子集，但不使用看不见的数据集。因此，本文还研究了在使用各种机器学习方法时，使用交叉验证与不可见数据集的性能限制。

我们的主要贡献如下：

1. 使用连续的机器活动数据(例如CPU使用、RAM/SWAP使用、网络i /O)来对恶意软件进行分类——因此不依赖于网络流量或API调用，这些调用目前可以被恶意软件本身加密或混淆。恶意软件可以检测和避免虚拟机，但它无法避免留下行为足迹，所以我们使用这些数据来分类恶意软件。连续数据的引入提供了在潜在攻击中识别模糊活动边界的机会；
2. 在使用交叉验证时，一些机器学习算法识别出过拟合，导致对未见数据的性能下降(代表是zero-day攻击)，而在交叉验证方面表现较好的其他算法在未见数据上测试时，过拟合的证据较少；
3. 使用自组织特征映射(SOFM)来处理机器活动数据，以捕获机器活动和类(恶意或可信)之间的模糊边界。

该方法克服了其他机器学习方法(如决策树和支持向量机)提出的过拟合问题(我们将性能结果作为SOFM改进的基线)。SOFM数据处理的另一个好处是机器活动数据的直观可视化表示。我们展示了两个竞争SOFMs的节点激活频率，以开发恶意和良性行为的行为可视化，这对安全运营中心(SOCs)的人工分析和恶意行为的可视化检测有影响。

## 二、相关工作

恶意软件分析分为两种主要方法。静态分析在不执行软件的情况下检查软件，检测字符串、字节序列、库调用和操作代码中的模式，以确定它是否是恶意的[3]。由于混淆技术使静态方法不可靠，静态方法本身被广泛认为是不充分的[4,5]。此外，该方法依赖于对已知恶意签名的匹配模式，这使得以前看不见的攻击（如多态恶意软件和Zero-day）难以检测。动态分析执行软件，并在一个称为沙盒的隔离环境中分析其执行过程中的行为。行为监控工具捕获软件和底层系统之间的交互，如进程细节、文件和注册表的更改，以及网络流量[3]。这种方法也不完美，因为攻击者能够检测沙箱环境并改变其行为以避免检测。然而，为了成功的攻击发生，恶意软件和它试图利用的底层系统之间的交互必须发生，并且动态分析提供了在这种交互过程中捕获度量的潜力，可以用来检测攻击[5]。

静态和动态方法的恶意软件分析均会生产数据，可以数据转化为恶意软件的特点，通过这些数据使得恶意软件模式的自动化检测成为热点。Ranveer和Hiray[5]在2015年进行了一项调查，整理和比较用于检测恶意软件的feature。虽然仍然有一些研究支持静态分析(例如字节码n-gram特性、操作码ngram特性和字符串)，但大多数文献表明恶意软件有太多的加密技术使得静态检测并不实际。Nataraj等人也支持这一观点，他们认为影响静态分析的二进制混淆技术”几乎被当今恶意软件发布者普遍采用”[6]。正如Ranveer和Hiary所说，任何恶意软件都会调用一些内核级的系统调用来与底层操作系统通信，因此捕获和分析内核交互可以使恶意软件[5]得以检测。他们的review提供了一个比较表，整理和比较了许多恶意软件检测系统的性能指标。同时引用了一些研究作为基准使用的标准数据集，然而许多研究论文没有使用这个数据集，所以很难进行真正的比较。在比较相关工作时，区分不同形式的恶意软件分类是很重要的。有研究试图将可执行文件分类为恶意或良性文件，还有研究旨在使用分类方法将恶意软件分类(例如[7,6,8,9,10])。我们的重点是检测恶意软件的执行，因此我们在分析相关工作时，重点在前者。

Tian等人使用支持向量机(Support Vector Machines, SVM)、随机森林(Random Forest, RF)、决策表(Decision Table, DT)和IB1 + AdaBoost以及基于频率的API调用，以Windows XP作为基本操作系统，使用RF和DT[11]实现97%的恶意软件分类准确率。这个结果是通过10倍交叉验证得到的。Firdausi等人使用K-Nearest Neighbour、J48 Decision Trees、SVM和多层感知器使用API调用在Windows XP基础操作系统上使用J48[12]产生96.8%的准确率。他们使用了250个恶意软件的小样本，所以我们假设这些结果也是交叉验证的。Damodaran等人使用带有API调用的隐马尔可夫模型(HMM)和静态/动态混合模型[13]。他们使用5倍交叉验证来实现基于家族的恶意软件分类的0.98 AUC-PR评分。他们证明了动态分析优于静态和混合分类。此外，他们在测试过程中扩张了良性类，发现分类器性能随着良性样本的增加而下降，并且发现动态方法比静态或混合方法表现更加稳定。Tobiyama等人使用长短期记忆(LSTM)模型[14]对81个恶意软件记录和69个良性软件记录进行特征提取。通过5折交叉验证，他们的AUC得分为0.96。Ahmed等人使用大约500个文件的数据集研究了API调用的顺序。使用10折交叉验证和朴素贝叶斯分类器[15]，得到了0.98 AUC的性能。

设备活动指标以前被用于移动平台(如Android)来检测恶意软件，由附加的指定设备度量(如SMS和按键数据[16])。在更传统的桌面计算环境中，Scaife等人研究了RansomWare，这是一种特殊类型的恶意软件，它大量使用对文件系统的读/写调用来加密用户的数据。他们使用与修改用户数据和可疑文件活动相关的基于规则的分类器，而不是机器学习，匹配了492个勒索软件攻击的样本，准确率为100%[17]。Continella等人也研究了RansomWare，并使用机器学习来检测这种使用文件系统调用的攻击。与许多现有文献不同，他们使用305个未见样本测试分类器，检测出97.7%的未见RansomWare攻击[18]。

这些结果显示了恶意软件分类的重大前景，但在大多数情况下，使用k折交叉验证会导致结果对未见样本的泛化能力弱的问题，迄今为止，还没有研究试图用非离散选择分类方法(non-discrete choice classification method)测试连续机器活动数据的适用性，以避免过拟合可能表现出广泛的可观察行为的看不见的一般恶意软件样本。在我们的研究中，我们将在最佳分类方法上使用未见测试数据集重现这些结果，从而为“未见数据会导致性能下降”的假设提供证据——特别是在随机森林和决策树等离散选择模型中，未见数据可能会有不同程度的表现。

Pascanu等人认为需要更多的研究来处理重新排序的时间模式，因此提出了一种使用回波状态网络(Echo State Networks)和递归神经网络（RNN）提取执行指令的方法，然后使用逻辑回归将恶意文件分类为真阳性率为71.71%，假阳性率为0.1%[19]。这里的一个关键点是经常性模型(recurrent model)和bag-of-evens模型(based on the probability theory)之间的比较，其中经常性方法显示了三个改进因素。将工作扩展到神经网络，Dahl等人使用360万个文件（来自Microsoft）使用逻辑回归、浅层和深度神经网络训练和测试模型。使用API调用，他们产生了0.49%的错误率和9个神经网络的集合。值得注意的是，表现最好的模型是浅神经网络（1层）。然而，Huang和Stokes在这项研究的基础上，使用600万（来自微软）的样本来训练和测试深度神经网络[21]。他们利用ReLU和Dropout取得了很好的效果，使用了114个API事件和参数实现了0.36%的错误率。在NN中添加更多层并没有在性能上取得显着提高（证实了Dahl等人的发现），增加样本量至几乎是Dahl等人的两倍亦无法提升性能——然而使用Dropout确实看到了改进，这表明优化神经模型的效率可以提高性能，而不是增加深度和数据集大小。这两个数据集都不是公开可用的，因此很难与这项研究进行基准测试。这两篇论文的一个关键限制是训练模型所花费的时间（并不是专门针对这项工作，而是指普遍的神经网络模型）。Dahl等人使用的模型训练花了将近3个小时，Huang和Stokes花了了7个小时。由于每天都有大量新的恶意软件出现，因此，要像现有的基于签名的反病毒系统那样，建立和部署这些模型来考虑“实时”出现的新样本，似乎是不可能的。在我们的研究中，我们将研究对抗学习模型的使用，该模型能够在不同数据集之间进行推广，并且能够进行在线学习，以便在新样本可用时以最少的训练时间提供新样本——这是自组织特征映射（SOFM）的一种属性。

## 三、方法

### 3.1 自适应特征映射

Kohonen（[22]）的自组织特征映射（SOFM）是一种无监督学习技术，它将实值的n维向量作为输入，并用它来修改随机种子向量的内容（称为模型或参考向量）存储在m维阵列（通常是二维网格，称为地图）中。重要的是，输入和模型向量可以存在于比地图本身更高维的空间中，因此允许降维。这意味着使用低维（例如2D）映射允许在更高维空间（例如5D）中方便地可视化数据点。然而，重要的是要注意，组成模型向量的属性的选择以及数据集的特征将决定SOFM对过拟合问题的易感性。

