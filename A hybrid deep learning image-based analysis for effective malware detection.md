# A hybrid deep learning image-based analysis for effective malware detection

互联网的爆炸性增长和最近使用智能应用程序的自动化趋势为恶意软件（malware）攻击者提供了名副其实的游乐场。随着各种设备通过互联网无缝连接并收集大量数据，不断升级的恶意软件攻击和安全风险成为一个大问题。尽管有多种恶意软件检测方法可用，但需要新方法来匹配此类数据密集型环境的规模和复杂性。我们提出了一种新颖且统一的混合深度学习和可视化方法，用于有效检测恶意软件。本文的目的有两个：1. 介绍使用基于图像的技术来检测系统的可疑行为，以及 2. 提出和研究基于混合图像的方法与深度学习架构的应用，以实现有效的恶意软件分类。通过采用恶意软件行为模式的各种相似性度量以及对成本敏感的深度学习架构来衡量性能。通过使用公共和私人收集的大型恶意软件数据集测试我们提出的混合方法来对可扩展性进行基准测试，这些数据集显示了我们的恶意软件分类器的高精度。

## 1. Introduction

随着我们进入由互联网技术和智能自动化的进步推动的第四次工业革命（工业 4.0），我们越来越多地面临安全漏洞。开发防御系统来抵御恶意软件 (malware) 攻击很重要，这些攻击可以通过在不获取任何用户许可和身份验证的情况下渗透他们的计算系统、数据和应用程序来破坏业务 [1,2]。 “恶意软件”一词涵盖范围广泛的恶意代码，例如计算机病毒、蠕虫和可能导致拒绝服务攻击的潜在有害程序 (PUP)。今天，一些恶意攻击是由现有恶意软件的未知变体引起的，这些变体混淆了它们的行为以逃避检测 [3]。随着种类繁多的开源软件和通过互联网无缝安装应用程序的兴起，有效检测这种大规模隐蔽生成的新型混淆恶意软件是一项重大挑战。因此，为了对抗这种恶意软件战争，网络安全领域的恶意软件检测解决方案正在不断发展，本文在这个研究方向上迈出了适度的一步。

几十年来，防病毒软件解决方案构成了最常用的用于检测和缓解恶意软件的商业系统。传统上，此类解决方案基于病毒签名，当遇到新的恶意软件时，需要人工干预来监督和更新签名数据库。最近，正在开发的机器学习系统能够减轻基于签名的系统的局限性 [4-6]。这种自学习系统能够采用数据挖掘和深度学习方法，可以促进复杂病毒模式的学习，以区分良性和恶意软件二进制文件。然而，不同的自学习方法在检测现有恶意软件甚至全新恶意软件的变体的能力方面表现出一定程度的可变性。正在进行多项研究，以探索不同的自学习技术方法对恶意软件检测的适用性，并将此类模型的可扩展性和性能与各种数据集进行比较 [7,8]。首先了解黑客采用的基本方法以及恶意软件混淆技术是很重要的，以便提出创新的解决方案模型来匹配这个网络安全问题。

最常用的恶意软件检测方法有两种主要技术：静态和动态分析[4-8]。 静态分析通过反汇编程序二进制文件来使用文件的语法和结构特性，以提取特征。 动态分析则需要在文件运行期间对其进行动态分析，以提取程序执行的特征动作。 以前的研究也结合了静态和动态方法 [9,10]。 当今的许多商业系统已经开始使用静态和动态分析的混合进行恶意软件检测。 然而，需要新的方法来改进检测黑客越来越多地发起的恶意软件的不同混淆的技术，最近的研究比较了静态、动态和混合方法，在当前范式中产生了各种影响 [4]。

恶意软件编写者采用多种混淆技术，使用变形和多态方法来生成现有恶意软件家族的变体，以逃避检测，这已成为一种常见做法 [3,4]。 此外，可以使用打包方法混淆整个程序二进制文件，以确保代码只能在运行时进行分析 [11]。 这种非标准和定制包装的逆向工程是劳动密集型的，需要在虚拟环境中执行二进制文件以进行解包 [12]。 因此，正在开发能够结合人类专家的自学特征的智能方法，例如机器学习。

已经研究了用于恶意软件的静态、动态和混合分析的机器学习模型，显示了检测混淆恶意软件的有希望的结果，并且已经研究了它们的影响，推动了在这个方向上的进一步研究 [4,13-16]。许多静态恶意软件检测方法通过探索支持向量机 (SVM)、隐马尔可夫模型 (HMM) k-最近邻 (KNN) 和朴素贝叶斯 (NB) [17,18] 等不同分类器来区分其工作。通常，对于基于动态分析的技术，通过执行恶意软件来分析恶意软件行为模式的各种痕迹。在文献中，两种常用的动态分析方法是**控制流分析**和 **API 调用分析** [3,6,13]。总的来说，之前的研究已经探索了几种基于特征的方法，包括高级 API 调用以及用于基于 n-gram 的恶意软件检测的低级操作码 [18-20]。半自动数据分析方法要求恶意软件分析师分析和解释中间结果，这可能很耗时，因此提出了自学习和智能框架 [21,22]。在这项工作中，我们采用了机器学习和相似性挖掘方法，这些方法已有效地应用于静态和动态恶意软件检测，并以基于图像的深度学习方法为重点。

基于图像的技术可以在检测可疑的未知恶意软件时提供复杂的视觉辅助，以便快速警告异常行为模式。恶意软件模式的可视化表示具有提供可能攻击的汇总图的优势。视觉分析以及人类专家的分析推理可以加快恶意软件检测过程 [23,24]。相似性挖掘是一种基于距离度量相似性分析的机器学习方法。在可视化分析中，最近采用相似性挖掘来检测恶意软件。通过使用基于图像的分析进行恶意软件检测，这项工作比之前的研究更进一步。在本文中，我们提出了一种混合模型，通过采用相似性挖掘和深度学习架构来准确检测混淆的恶意软件并将其分类到其恶意软件家族中。不同恶意软件家族的图像比较以及良性数据集用于直观地展示恶意软件家族行为模式的显着差异。此外，采用深度学习技术来促进自学习，从而在我们提出的分类器中实现高精度。

总的来说，我们提出的模型的主要贡献是：

1. 通过采用具有计算成本效益和可扩展性的基于图像的机器学习技术，开发用于恶意软件检测和分类的混合深度学习模型。
2. 通过对不同公共和私有数据集的各种经典机器学习和深度学习技术进行深入分析来进行实验研究，目的是评估我们提出的架构在处理新恶意软件系列的大型数据集方面的有效性。

我们将论文的整体结构组织如下。 第 2 节提供了计算机安全领域基于图像的分析的相关工作。 本研究采用的拟议混合模型在第 3 节中介绍。第 4 节描述了用于研究的实验设置和数据集。 第 5 节介绍了我们提出的模型的性能评估结果，表明使用机器学习和深度学习架构实现了高分类精度。最后，我们提供了我们的结论，在第 6 节中强调了研究和未来研究工作的局限性。

## 2. Related work

许多使用模式相似性的基于图像的分析分为两大类：（1）面向投影或（2）面向语义[25]。在计算机安全领域，可视化工具经过了一段时间的发展，对于处理大文件的海量数据变得越来越有用。相似性矩阵的二维可视化是一种传统技术，用于捕获对象之间的相关相似性度量 [26,27]。它提供了三个关键特性：（i）一旦形成相似空间，数据的高维部分不影响进一步处理； (ii) 形成具有同等重要性的集群，并且 (iii) 彼此相关的集群显示为彼此相邻，有助于结果的可视化 [25]。将文档直观地表示为 2D 或 3D 平面上的点是一种常见的做法。每对点之间的距离表示两个文档的相似程度，即它们越接近，两个文档内容越相似[28,29]。

最近，研究采用了基于图像的网络安全攻击分析 [30]。一些半自动化技术涉及对安全外壳 (SSH) 蛮力尝试的视觉调查，这些尝试通过不同颜色识别出的各种异常以及用户 ID 和互联网协议 (IP) 地址的详细信息 [31]。可视化技术也被用来一次显示大数据包的概览。这些图像显示了网络数据包之间的关系，这有助于安全分析师放大到更多细节 [32]。另一项研究使用基于图像的分析来解释恶意软件攻击的时间顺序，例如鱼叉式网络钓鱼攻击，并用颜色指示成功连接到系统的类型 [33]。图 1 显示了这些连接的“什么”、“哪里”和“何时”的信息，以及如何使用它们的 IP 地址来估计到其他主机的距离 [34,35]。各种类型的警报在连续的时间间隔内显示为同心环的单独扇区，对同一主机的不同可能攻击用颜色编码的连接来描述。这些视觉技术大多采用基于文本的网络参数和日志分析来获得不同颜色的图像表示，用于半自动分析和检测恶意软件攻击。此类研究非常受限制，重点是网络流量和渗透分析 [36,37]。此外，这些在当今的大数据世界中非常耗时，并且正在探索基于图像纹理表示及其分析的各种方法 [38]。

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/1-s2.0-S2214212618304563-gr1_lrg.jpg" alt="img" style="zoom: 15%;" />

图1 网络连接类型（什么）、被攻击的资源（哪里）和时间（何时）的可视化。

可执行二进制文件的不同部分表示为独特的图像纹理，以便进行更快的分析，从而提高恶意软件分析师的工作效率。 这种基于纹理的图像分析的优势在于，它们可以提供有关恶意软件结构的更多信息，显示即使是很小的代码更改，同时保留了代码的整体结构。 图 2(a) 显示了显示独特纹理的二进制代码的不同部分，这有助于识别相似的模式 [38]。 例如，图 2(b) 显示了属于同一恶意软件家族的四种恶意软件变体的图像相似性，称为 Dialplatform.B。

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/1-s2.0-S2214212618304563-gr2_lrg.jpg" alt="img" style="zoom:20%;" />

图2 显示二进制部分相似性的恶意软件家族变体的图像

基于纹理的恶意软件图像分析的主要限制是某些恶意软件混淆无法轻松分析。 恶意软件可以使用不同的打包方法和不同的分辨率进行打包。 因此，需要一种改进的解决方案来使用基于图像的分析对恶意软件进行分类 [39]。 最近，为了对混淆的恶意软件进行分类，已经分析了称为要点描述符的图像特征，并且将这些技术与深度学习技术进行了比较，以评估其鲁棒性 [40]。 研究人员正在探索几种此类创新技术，以解决混淆恶意软件检测的主要挑战。 

在本文中，我们提出了各种有监督和无监督技术的混合模型来执行图像分析，以有效地检测和分类未知恶意软件。 通过使用各种大型公共和私有数据集，我们进行了实验研究，以证明如何在所提出的分类器中有效地采用相似性挖掘与深度学习架构相结合。 我们提出的模型将在下一节中描述。

## 3. Proposed Hybrid Model

深度学习是一种机器学习，已在不同领域的各种应用中使用。这主要是因为这些方法能够通过获取原始输入样本隐式地学习最佳特征表示。最近，深度学习架构的应用被用于恶意软件检测。在基于图像的深度学习方法中，恶意软件二进制文件被转换为灰度图像表示，并采用深度学习架构来学习复杂的特征（图像模式）[40-45]。最常用的深度学习架构是卷积神经网络 (CNN) 和长短期记忆 (LSTM)。这两种方法的根本区别在于CNN能够提取空间特征，而LSTM能够学习序列信息。 CNN 和 LSTM 都可以结合起来有效地学习空间和序列信息。最近的一项研究使用 TensorFlow 进行依赖于迁移学习的深度学习实验，并且能够获得超过 98% 的测试准确率 [40]。在另一项工作中，提出了一种基于 CNN 的恶意软件分类方法来处理类不平衡问题，与基于经典机器学习算法的现有众所周知的方法相比，取得了良好的结果 [41]。另一项工作提出了一种将字节文件转换为图像表示的新方法，并采用了深度学习架构进行分类 [42]。

为了避免类不平衡问题，他们的实验采用了随机抽样和类再平衡抽样方法。 类重新平衡方法比现有的基于经典机器学习的方法表现更好，具有最高的 F1-score。 一些研究人员提出了一种恶意软件分类框架，通过使用 SimHash 将反汇编的恶意软件代码转换为灰度图像，并使用 CNN 进行分类 [43,44]。 另一项工作提出了基于 RNN 和 CNN [45] 组合执行恶意软件分类的操作码静态分析。 最近的一项研究采用了成本敏感的 LSTM 来处理类不平衡和多类分类问题，结果显示出比成本不敏感的 LSTM 更好的性能 [46]。

本文比之前的工作更进一步，提出了一种基于混合深度学习的入侵检测框架 [47]。 在之前的工作中，通过使用各种公开可用的数据集进行多次实验，开发了最佳机器学习模型。 结果表明，该方法可以很好地扩展以处理大量网络事件，同时使用图像分析和深度学习方法在实时环境中有效地检测和分类攻击。 这项工作采用了类似的方法，但在使用基于图像的深度学习分析将恶意软件变体分类到其恶意软件家族的重点上有明显不同。 提出的混合架构使用监督和无监督学习模型的组合进行基于图像的恶意软件分类，如图 3 所示。

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/1-s2.0-S2214212618304563-gr3_lrg.jpg" alt="img" style="zoom:20%;" />

图3 本文提出的混合架构模型

本文所提出的架构使用自学习系统，该系统不仅能够检测已知恶意软件和已知恶意软件的变体，还能够检测未知恶意软件。更重要的是，**自学习系统使用经典机器学习和当代深度学习模型来捕捉二进制文件的复杂特征**，这些特征可以最好地用于区分良性和恶意二进制文件。该架构由三个不同的子系统组成，其中一个子系统基于无监督学习模型，另外两个子系统基于监督学习模型。图 3 中所示的每个预处理阶段用于将二进制文件转换为不同的特征表示，以便采用机器学习和深度学习模型。为了增强对混淆恶意软件的恶意软件检测，可以在实时系统中使用这种类型的混合系统。所有这些子系统都使用经典和高级机器学习模型和基于图像的分析来有效地学习恶意软件二进制文件的复杂系统行为。

本文提出的的恶意软件分类深度学习架构使用 CNN 和双向管道。 包括误算成本，一般而言，包含较多恶意软件样本的恶意软件家族计算成本较低，而包含较少样本的恶意软件家族计算成本较高。 一开始，成本矩阵是未知的，并采用遗传算法来找出最优成本矩阵。 然而，这种方法耗时且计算成本高。 因此，为了为每个样本选择一个最优值，让我们假设至少一个类别样本具有相同的成本。 让$c[i,i]$表示类 $i $的误分类成本，它是使用下式中定义的类分布生成的：
$$
c[i,i]=(\frac{1}{n_i})(\frac{1}{n_i})^\gamma
$$
其中$\gamma \in [0,1]$是一个权衡参数。 当$\gamma = 1$时，$c[i, i]$ 与类大小 $n_i$成反比，当$\gamma = 0$ 时，成本敏感的 LSTM 减少为原始 LSTM，成本不敏感。 为了找到$\gamma$的最佳值，我们对本文提出的的架构运行了 3 次，其值在 0 到 1 的范围内，最终得出当$\gamma = 0.2$时表现良好。

卷积神经网络（CNN）是经典神经网络的改进模型，在计算机视觉领域的各种长期人工智能任务中表现良好[39]。首先，CNN 由三个不同的层组成，卷积层、池化层和全连接层。卷积层包含一个卷积操作，该操作使用过滤器在图像上滑动以捕获特征。通过使用修正线性单元 (ReLU)，这些特征被映射到称为特征映射的非线性空间中。由于特征图的维度可能非常大，我们使用池化来降低维度。最常用的池化操作是 max、min 和 average 函数，我们使用 max-pooling。池化特征被传递到双向门控循环单元（GRU），它学习字节序列的顺序信息，最后，特征被传递到全连接层。我们使用非线性激活函数进行分类，最常用的函数是用于二元分类的 sigmoid 和用于多类分类的 Softmax。为了减少训练过程中的损失，我们使用了分类交叉熵：
$$
loss(p,e)=\sum_ip(x)log(e(x))
$$

其中 $x$ 表示输入，$e$ 和 $p$ 分别表示真实概率分布和预测概率分布。

基于图像的技术利用恶意软件样本的二进制数据或行为日志的视觉图像 [48,49]。基于特征的技术基于提取的特征来比较不同的恶意软件样本 [15]。先前的研究已经考虑将基于图像和基于特征的技术结合起来进行恶意软件分类，而无需执行或反汇编恶意软件代码（例如图 2）[38,50]。然而，由于它们仅使用选定的文件格式和打包方法进行操作的局限性，在这项工作中，我们提出了新的基于图像的分析技术，包括恶意软件**行为模式的相似性挖掘**。在另一项相关工作中，操作码序列被转换为图像矩阵中的 RGB 像素，并计算图像矩阵的相似性 [51]。我们的方法在两个方面有所不同，这是基于先前工作的改进 [18-20,24,47]。首先，我们利用以前工作中私下收集的大约 52,000 个恶意软件样本的大型数据集以及常用的公共数据集来对我们的研究进行基准测试。其次，使用相似矩阵和深度学习架构，我们采用**基于特征**的技术和**基于图像**的分析的混合方法来准确分析恶意软件二进制文件。以前从未尝试过这种混合深度学习架构，本研究的目的是评估所提出方法的性能增强。

我们提出的恶意软件分析混合模型由一个无监督学习模型和两个监督学习模型组成，如图 3 所示。预处理阶段涉及采用多种打包二进制检测器技术来自动从数据集中分离打包和解包文件 [19] ,20]。在预处理阶段，采用受控执行环境来检索原始消息，以到达执行的属于数据集中可执行文件的函数调用。对这样一个包含约 52,000 个二进制样本的私人收集数据集的预处理表明，大约 77% 的恶意软件被打包，只有 23% 被解包。特征处理阶段涉及有效地应用特征提取技术以使用数据挖掘技术进行特征分析。所有可执行程序都使用 API 函数调用执行操作，Windows API 调用序列的统计分析反映了特定代码段的行为。还提取了二进制 n-gram 特征以进行分析，以执行 n-gram 统计建模，以获得从 1 到 5 变化的一系列 n 值的可执行文件的分布。提取二进制 n-gram 特征以补充 API 调用特征具有独特地帮助正确训练分类器。总体而言，第一个监督学习模型使用私有数据集来训练、验证和测试一系列机器学习分类器，包括支持向量机 (SVM) 方法。这些特征的每次比较都会生成一个相似度矩阵，并通过相似度度量模块生成相似度报告。

表 1 和表 2 提供了同一家族中恶意软件的相似性矩阵的说明。 它们都代表被比较的每个家族的恶意软件变种。 表 1 为恶意软件家族 Trojan.Downloader.Win32.Dadobra 的相似度矩阵，表 2 为恶意软件家族 Worm.Win32.Delf 的相似度矩阵。 表列是表示同一恶意软件系列的不同版本或变体的二进制文件扩展名。 例如，表 1 中的“.aa”和“.aj”列指的是同一恶意软件家族TrojanDownloader:Win32/Dadobra的变种的两个文件扩展名 。 对于相似度分数，我们采用了余弦相似度度量，这是计算两个向量之间相似度的标准距离度量，如以下式子，余弦相似度已成功用于信息检索和恶意软件检测。
$$
cos(a,b)=\frac{ab}{\sqrt{\abs{a}^2\abs{b}^2}}
$$
计算相似度分数，范围在 -1 到 1 之间，用于开发各种恶意软件家族的相似度矩阵。 然后根据与阈值的不同距离，为每个矩阵中的值赋予不同的配色方案。 开发的图像模式与其他样本进行比较，以识别组或恶意软件家族。

在图像分析部分，从一个预训练的深度卷积神经网络 (CNN) 模型中提取图像特征，然后使用 k 均值聚类算法在图像特征空间中进行聚类。 一般来说，从 CNN 模型中提取的恶意软件特征是高维的。 因此，这些被传递到 t-分布式随机邻居嵌入 (t-SNE) 算法中，该算法使用主成分分析 (PCA) 技术的概念。 PCA 将高维特征减少为两个主成分特征。 最后，通过在 X 轴上绘制第一个特征和在 Y 轴上绘制第二个特征来可视化这些特征。 图 4 显示了在 X 和 Y 轴上绘制的各种恶意软件数据点与前两个主要成分特征的质心的距离。

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/1-s2.0-S2214212618304563-gr4_lrg.jpg" alt="img" style="zoom:25%;" />

图4 基于两个主成分特征（X-Y轴）的k均值聚类恶意软件数据

在获得相似性矩阵时，分类方法需要训练数据来验证在这些模型中制定的阈值。我们采用 k 折交叉验证方法来评估从统计分析中获得的结果。通过使 k = 10，完整数据集的 90% 用于“训练”（10% 用于“测试”），用于每个独立的 10 折。为了获得更高的泛化预测模型的准确性，使用 k 折交叉验证方法并将其应用于测试数据，k = 10。在 10 折交叉中完成特征选择和分类的评估-所有恶意软件和良性数据集的验证循环。然后将 SVM 应用于“训练”数据集，目的是为“测试”数据集生成预测模型。使用八种不同距离度量的不同相似性挖掘度量被用于对结果进行基准测试。基于以下标准措施比较了恶意软件分类的准确性：

1. 真阳性（TP）：正确识别的恶意代码数， 
2. 假阳性（FP）：当检测器将良性文件检测为恶意软件时错误识别的良性代码的数量。
3. 真阴性（TN）：正确识别的良性代码数。 
4. 假阴性（FN）：当检测器未能检测到恶意软件时错误识别的恶意代码的数量。

使用以下性能指标评估该混合模型的效率： 
$$
Overall Accuracy = \frac{TP+TN}{TP+TN+FP+FN}=\frac{TP+TN}{P+N}
$$
其中$P=TP+FN$，$N=FP+TN$。

尽管在之前的研究中分析了 API 调用以分析恶意软件及其家族 [18-20]，但在本研究中，我们增强了最近研究工作中的模型 [22,24,52]。 这里的重点是为基于图像的分析开发机器学习和深度学习架构的混合模型，以实现更高的性能和可扩展性。

此外，我们已经使用公开的基准公共数据集对结果进行了验证，例如 Microsoft 恶意软件分类挑战赛（BIG，2015）和 Malimg。 实验细节和研究结果将在后续章节中介绍。

## 4. Experimental Setup, Datasets and Results

我们使用不同的数据集对我们提出的混合模型进行了实验研究。首先，通过对Python编程语言中的各种数据挖掘算法进行距离度量和分析，进行了相似性分析。该实验在三个不同的处理器中运行，这有助于有效的恶意软件分类，并使用非常大的真实恶意软件数据集进行评估，该数据集由通过 VX Heavens [53] 等公共数据库获得的约 75,000 个样本组成。超过三分之二的样本是恶意软件，其余是良性样本。本研究开发的相似距离系统能够自动识别所有恶意软件变种。表 1 和表 2 提供了同一家族中恶意软件的相似性矩阵的说明。在这些矩阵中，计算出的相似性度量根据与阈值的距离进行颜色编码。这些距离度量可以取 0 到 1 之间的值，高度正相关（接近于 1 的值）以蓝色显示，表示高度相似，而低相关（接近于 0 值）以红色显示以表示高度相似。代表低相似度。我们通过使用公式 $((1 - m) - 0.5)\times 2$ 将距离度量 (m) 从 $[0, 1]$ 范围缩放到相似性度量$ [−1, 1]$ 范围。此外，我们利用颜色强度和圆圈的大小与相关系数成正比。我们使用 `R corrplot` 函数将相关矩阵转换为图形相关图。

可视化表示的图像模式分析表明，表 1 与名为 Win32.Dadobra（木马）的已知恶意软件非常相似，而表 2 与名为 Win32.Delf（蠕虫）的已知恶意软件相似。 此外，我们在每对恶意软件家族之间进行了实验比较，以了解它们的行为模式是否相似。 例如，表 3 显示了两个不同恶意软件家族 Win32.Dadobra 和 Win32.Delf 之间的相似度矩阵，表 4 显示了所有良性文件的相似度矩阵。

从相似矩阵得到的实验结果可以看出，混淆后的恶意软件或同一家族的变种在图像模式上表现出很高的相似性，而不同家族的恶意软件表现出明显不同的图像模式。 此外，实验证实，不同的良性文件之间没有相似性，但它们表现出相似矩阵的相似图像表示，这与恶意软件的图像表示明显不同。

我们进行了进一步的实验研究，通过使用两个公开可用的数据集来对我们提出的混合深度学习模型进行基准测试：i）Microsoft 恶意软件分类挑战（BIG，2015）数据集 [42] 和 ii) Malimg 数据集 [54]。 第一个数据集包含 10,868 个样本和 9 个恶意软件系列的标记训练数据集，这些数据集在 Kaggle 上公开可用。 每个恶意软件家族的详细统计数据如表 5 所示。第二个数据集包含 25 个恶意软件家族的 9342 张灰度图像，我们从中准备了 70% 的不相交数据集用于训练，其余 30% 用于测试。 为了进行实验研究，我们在单个 NVidia GK110BGL Tesla k40 系统 [43,44] 中的支持 GPU 的计算机上使用 TensorFlow 和 Keras 更高级别的 API 实现了深度学习架构。

在接下来的小节中提供了对我们实验研究的结果和观察结果的详细分析。

有两种类型的度量，即微观平均和宏观平均，用于识别模型整体分类的质量。 在宏观平均中，一个度量在所有类别上平均，并且它们被平等对待。在微观平均中，微平均基于累积真阳性 (TP)、假阳性 (FP)、真阴性 (TN) 和假阴性 (FN) 度量。 一般来说，微平均类型对具有更多样本的类给予重视，而宏观平均类型为多类不平衡问题提供更好的指标。 因此，在本研究中，由于公开可用数据集的多类不平衡性质，我们采用宏观平均作为实验评估的指标。 所使用的指标，即宏观平均精度、召回率和 F1 分数在等式中定义。 (5)-(7) 分别为：
$$
Precision_M=\frac{\sum _i \frac{TP_i}{TP_i + FP_i}}{Number\ of\ Classes} \\
Recall_M==\frac{\sum _i \frac{TP_i}{TP_i + FN_i}}{Number\ of\ Classes} \\
F1-Score_M = \frac{2}{\frac{1}{Precision_M} + \frac{1}{Recall_M}}
$$
**Microsoft 恶意软件分类挑战赛（BIG，2015 年）使用深度学习架构的数据集分析：**
数据集中的恶意软件样本由二进制文件组成，这些文件使用 [55] 提出的方法转换为图像表示。这种类型的图像表示保留了二进制文件中字节码的顺序。由于循环神经网络 (RNN) 架构是用于顺序数据建模任务的众所周知的方法，因此我们将 RNN 与 CNN 堆叠在一起以评估我们提出的混合深度学习模型。与单独采用 CNN 模型相比，这为我们的实验研究实现了最佳性能。表 6 中提供了具有单向 LSTM (UniLSTM) 和双向 LSTM (BiLSTM) 以及提议的单向 GRU (UniGRU) 和双向 GRU (BiGRU) 模型的现有 CNN 架构的可学习参数信息。

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/image-20220107104524317-16415235255162.png" alt="image-20220107104524317" style="zoom: 50%;" />

我们测量了使用 3 折交叉验证的深度学习模型的性能如表 7 所示。

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/image-20220107104605050-16415235663393.png" alt="image-20220107104605050" style="zoom: 50%;" />

最佳执行模型的参数详细信息显示在表 8 和 9 中。

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/image-20220107104630182-16415235911224.png" alt="image-20220107104630182" style="zoom: 50%;" />

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/image-20220107104646421-16415236073555.png" alt="image-20220107104646421" style="zoom:50%;" />

所提出的方法比现有所有实验中成本敏感/成本不敏感的方法表现更好。更重要的是，成本敏感模型的表现优于成本不敏感模型。表 10 和 11 中提供了最佳执行方法的性能详细信息。

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/image-20220107104909842-16415237508266.png" alt="image-20220107104909842" style="zoom:50%;" />

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/image-20220107104920884-16415237620187.png" alt="image-20220107104920884" style="zoom:50%;" />

对于所有恶意软件系列，与成本不敏感模型相比，成本敏感模型获得了最佳 F1 分数。最重要的是，与现有方法相比，所提出的成本敏感模型的 F1 分数性能提高了 0.0969。与现有方法相比，所提出的架构包含更少的参数，因此，它甚至可以降低训练和测试阶段的计算复杂度。

**使用深度学习体系结构进行Malimg数据集分析：** 
我们使用 Malimg 数据集评估了各种深度学习模型，结果见表 12 。

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/image-20220107105043198-16415238439238.png" alt="image-20220107105043198" style="zoom:50%;" />

我们在表 13 中提供了我们提供的最佳模型的类别性能。

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/image-20220107105137015-16415238982669.png" alt="image-20220107105137015" style="zoom:50%;" />

本文所提出的模型比现有方法 [56] 的性能更好，并且成本敏感模型表现出优于成本不敏感模型的良好性能。 通过确定深度学习架构的最佳参数值，可以进一步提高性能。

## 5. Performance Evaluation

我们使用各种深度学习模型进行了三项实验，以测试我们提出的架构。 实验一直运行到 100 个 epoch，批量大小为 64，并且使用了学习率为 0.001 的 Adam 优化器。 深度学习架构在准确性和训练损失方面的训练和验证性能如图5和图6所示。 所有模型在各个时期都逐渐提高了准确性并减少了训练损失。 更重要的是，一旦达到 50 个 epochs，模型就取得了更好的性能。 此外，所有模型在 50 个 epoch 后都逐渐提高了性能。

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/1-s2.0-S2214212618304563-gr5_lrg.jpg" alt="img" style="zoom:20%;" />

图5 成本敏感型深度学习模型精度比较

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/1-s2.0-S2214212618304563-gr6_lrg.jpg" alt="img" style="zoom:20%;" />

图6 成本敏感型深度学习损失值比较

我们还使用从 VX Heavens [53] 私人和公开收集的大型数据集进行了一项实验研究，通过比较恶意软件和良性文件分类的准确性来评估机器学习算法的四种变体的性能。我们的基于特征和基于图像的分析混合模型使用具有八种不同距离度量的相似性挖掘来检测和分类未知恶意软件的实验结果显示出有希望的结果。相似性挖掘和深度学习架构可有效检测来自同一家族或不同家族的恶意软件变种。此外，实验证实不同良性文件之间没有相似性，但它们的相似矩阵确有着相似的图像表示，这是与恶意软件的唯一不同。在分类算法中，通过对恶意软件和良性数据集进行分区来选择训练数据和测试数据进行实验。我们采用了最常见的交叉验证类型，即 k 折交叉验证，这是许多分类器采用的类似研究中采用的标准做法 [57]。对于相似性挖掘，我们在支持向量机 (SVM) 方法中采用了具有 4 个不同内核的序列最小优化 (SMO) 算法：i) SMO-Normalized Polynomial Kernel Function, ii) SMO-Polynomial Kernel Function, iii) SMO-Radial Basis函数 (RBF) 和 iv) SMOPearson VII 核函数 (PUK)。 SMO 的优势在于它能够通过 SVM 的快速实现来解析地求解拉格朗日乘子。此外，它是一种流行的监督学习算法，用于分类和回归问题。在图 7 中，显示了使用 SMO 的四个内核为我们的实验数据集实现的恶意软件检测的总体准确率。

<img src="A hybrid deep learning image-based analysis for effective malware detection.assets/1-s2.0-S2214212618304563-gr7_lrg.jpg" alt="img" style="zoom:25%;" />

归一化多项式核函数方法在所有 k 个交叉验证中准确度最高，$k=\{2,3,4,5,6,7,8,9,1\}$。特别是，当 $k = 10$ 时，我们实现了基于 SVM 的恶意软件检测的大约 98.6% 的准确率，这是迄今为止使用大型数据集的文献中报道的最好的结果之一。

## 6. Conclusions

本文提出了一种新的混合模型，用于使用相似性挖掘和深度学习架构进行基于图像的分析，以准确识别和分类混淆的恶意软件。 我们使用八种不同的距离度量来计算恶意软件变体之间的相似性，以生成相似性矩阵并通过采用距离分数的图像来识别恶意软件家族。 此外，还对深度学习架构进行了基准测试，从而获得了较高的分类准确率。 在 SMO 归一化多项式核函数的方法中，我们实现了近 99% 的准确率，我们提出的成本敏感型深度学习架构的性能与文献中报道的一些最佳架构相当。 总之，我们设想我们的基于图像的方法有效区分了不同恶意软件家族的行为模式。

与经典的基于机器学习的方法相比，本文所提出的方法的优点是它需要更少的计算成本。 此外，本文所提出的基于成本敏感的深度学习模型可以持续实时训练，以应对未来的新恶意软件。

我们希望在未来的工作中进一步加强我们提出的框架。 同一组实验可以运行 100 多个 epochs 以达到更好的性能。 未来研究的另一个范围可以考虑我们提出的方法与最近文献中报道的其他创新图像分析技术的交叉点。

